<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karta partnera</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; }

    .popup { font-family: Arial, sans-serif; font-size: 13px; line-height: 1.35; }
    .popup hr { margin: 6px 0; }

    .topbar {
      position: absolute; z-index: 999;
      top: 10px; left: 10px; right: 10px;
      display: flex; gap: 8px; flex-wrap: wrap;
      align-items: center;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      max-width: 1100px;
    }
    .topbar input {
      flex: 1;
      min-width: 220px;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    .topbar button {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    .status { font-size: 13px; color: #333; }

    .legend {
      position: absolute;
      z-index: 999;
      bottom: 16px;
      left: 16px;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px 12px;
      font-family: Arial, sans-serif;
      font-size: 13px;
      line-height: 1.3;
      max-width: 260px;
    }
    .legend-title { font-weight: 700; margin-bottom: 8px; }
    .legend-row { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .swatch { width: 12px; height: 12px; border-radius: 50%; border: 2px solid #00000022; }
  </style>
</head>

<body>
  <div class="topbar">
    <input id="q" type="text" placeholder="Pretraži po ID / nazivu / struci / mjestu / adresi..." />
    <button id="btnReset" type="button">Reset</button>
    <span class="status" id="status">Učitavam podatke…</span>
  </div>

  <div class="legend" id="legend">
    <div class="legend-title">Struka</div>
    <div class="legend-row"><span class="swatch" style="background:red;"></span> Instalater(i)</div>
    <div class="legend-row"><span class="swatch" style="background:blue;"></span> Arhitekt(i)</div>
    <div class="legend-row"><span class="swatch" style="background:green;"></span> Prodavač(i)</div>
    <div class="legend-row"><span class="swatch" style="background:gray;"></span> Ostalo / prazno</div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR-5B8-SGXI7FSbUA6gsgpKfECUKq2OnVCj4qM8npiWkrH5gQL00PAfv_NsazCgBNDEv6kwwxOg4Z_x/pub?output=csv";

    const map = L.map("map").setView([45.1, 15.2], 7);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(map);

    const layer = L.layerGroup().addTo(map);
    const statusEl = document.getElementById("status");
    const qEl = document.getElementById("q");
    const btnReset = document.getElementById("btnReset");

    // VAŽNO: ključevi su malim slovima jer struku normaliziramo na lowercase
    const STRUKA_BOJE = {
      "instalater": "red",
      "instalateri": "red",
      "arhitekt": "blue",
      "arhitekti": "blue",
      "prodavač": "green",
      "prodavac": "green",
      "prodavači": "green",
      "prodavaci": "green",
      "građevinar": "green",
      "građevinari": "green",
      "održavanje zgrada": "yellow",
      "strojarski projektant": "orange"
    };

    function getColorByStruka(struka) {
      const key = String(struka || "").toLowerCase().trim();
      return STRUKA_BOJE[key] || "gray";
    }

    let items = [];

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];

        if (ch === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
        if (ch === '"') { inQuotes = !inQuotes; continue; }

        if (ch === "," && !inQuotes) { row.push(cur); cur = ""; continue; }
        if ((ch === "\n" || ch === "\r") && !inQuotes) {
          if (cur.length || row.length) { row.push(cur); rows.push(row); }
          cur = ""; row = [];
          continue;
        }
        cur += ch;
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }
      return rows;
    }

    function toNum(x) {
      const v = parseFloat(String(x || "").trim().replace(",", "."));
      return Number.isFinite(v) ? v : null;
    }

    function normalize(s) {
      return String(s || "").toLowerCase().trim();
    }

    function escHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function findColIndex(header, name) {
      const h = header.map(x => normalize(x));
      return h.indexOf(normalize(name));
    }

    function normalizeWeb(url) {
      const u = String(url || "").trim();
      if (!u) return "";
      if (u.startsWith("http://") || u.startsWith("https://")) return u;
      return "https://" + u;
    }

    function renderMarkers(filterText) {
      layer.clearLayers();

      const ft = normalize(filterText);
      const filtered = ft ? items.filter(it => normalize(it.search).includes(ft)) : items.slice();

      for (const it of filtered) {
        const webLink = it.web ? normalizeWeb(it.web) : "";
        const color = getColorByStruka(it.struka);

        const html = `
          <div class="popup">
            <b>${escHtml(it.naziv)}</b><br>
            ${escHtml(it.adresa)}<br>
            ${escHtml(it.pbr)} ${escHtml(it.mjesto)}<br>
            <hr>
            ${it.id ? `<b>ID:</b> ${escHtml(it.id)}<br>` : ""}
            ${it.struka ? `<b>Struka:</b> ${escHtml(it.struka)}<br>` : ""}
            ${it.osoba ? `<b>Odgovorna osoba:</b> ${escHtml(it.osoba)}<br>` : ""}
            ${it.tel ? `<b>Telefon:</b> ${escHtml(it.tel)}<br>` : ""}
            ${it.email ? `<b>E-mail:</b> ${escHtml(it.email)}<br>` : ""}
            ${it.web ? `<b>Web:</b> <a href="${escHtml(webLink)}" target="_blank" rel="noopener">${escHtml(it.web)}</a><br>` : ""}
          </div>
        `;

        L.circleMarker([it.lat, it.lon], {
          radius: 7,
          color: color,
          weight: 2,
          fillColor: color,
          fillOpacity: 0.85
        })
          .bindTooltip((it.id ? (it.id + " - ") : "") + (it.naziv || "Partner"))
          .bindPopup(html, { maxWidth: 440 })
          .addTo(layer);
      }

      statusEl.textContent = `Prikazano: ${filtered.length} / ${items.length}`;

      if (filtered.length > 0) {
        const bounds = L.latLngBounds(filtered.map(it => [it.lat, it.lon]));
        map.fitBounds(bounds.pad(0.12));
      }
    }

    async function loadData() {
      statusEl.textContent = "Učitavam podatke…";

      const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Ne mogu učitati CSV (HTTP " + res.status + ")");

      const csvText = await res.text();
      const table = parseCSV(csvText);
      if (table.length < 2) throw new Error("CSV nema podataka.");

      const header = table[0];

      const iID     = findColIndex(header, "ID");
      const iStruka = findColIndex(header, "Struka");
      const iNaziv  = findColIndex(header, "Naziv");
      const iAdresa = findColIndex(header, "Adresa");
      const iMjesto = findColIndex(header, "Mjesto");
      const iPbr    = findColIndex(header, "Poštanski broj");
      const iOsoba  = findColIndex(header, "Odgovorna osoba");
      const iTel    = findColIndex(header, "Telefon");
      const iEmail  = findColIndex(header, "E-mail");
      const iWeb    = findColIndex(header, "Web");
      const iLat    = findColIndex(header, "Latitude");
      const iLon    = findColIndex(header, "Longitude");

      if (iNaziv === -1 || iAdresa === -1 || iMjesto === -1 || iPbr === -1 || iLat === -1 || iLon === -1) {
        throw new Error("Nedostaje obavezan stupac: Naziv, Adresa, Mjesto, Poštanski broj, Latitude, Longitude.");
      }

      const out = [];
      for (let r = 1; r < table.length; r++) {
        const row = table[r];

        const lat = toNum(row[iLat]);
        const lon = toNum(row[iLon]);
        if (lat === null || lon === null) continue;

        const id     = iID     !== -1 ? (row[iID] ?? "") : "";
        const struka = iStruka !== -1 ? (row[iStruka] ?? "") : "";

        const naziv  = row[iNaziv]  ?? "";
        const adresa = row[iAdresa] ?? "";
        const mjesto = row[iMjesto] ?? "";
        const pbr    = row[iPbr]    ?? "";

        const osoba  = iOsoba !== -1 ? (row[iOsoba] ?? "") : "";
        const tel    = iTel   !== -1 ? (row[iTel]   ?? "") : "";
        const email  = iEmail !== -1 ? (row[iEmail] ?? "") : "";
        const web    = iWeb   !== -1 ? (row[iWeb]   ?? "") : "";

        out.push({
          lat, lon,
          id, struka, naziv, adresa, mjesto, pbr,
          osoba, tel, email, web,
          search: `${id} ${struka} ${naziv} ${adresa} ${mjesto} ${pbr} ${osoba} ${tel} ${email} ${web}`
        });
      }

      items = out;

      if (items.length === 0) {
        statusEl.textContent = "Nema valjanih koordinata u tablici (Latitude/Longitude).";
        return;
      }

      renderMarkers(qEl.value);
    }

    qEl.addEventListener("input", () => renderMarkers(qEl.value));
    btnReset.addEventListener("click", () => { qEl.value = ""; renderMarkers(""); });

    setInterval(() => {
      loadData().catch(err => {
        console.error(err);
        statusEl.textContent = "Greška pri osvježavanju podataka (vidi konzolu).";
      });
    }, 60000);

    loadData().catch(err => {
      console.error(err);
      statusEl.textContent = "Greška: " + err.message;
      alert("Greška: " + err.message);
    });
  </script>
</body>
</html>


