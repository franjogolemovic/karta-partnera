<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karta partnera</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; }

    .popup { font-family: Arial, sans-serif; font-size: 13px; line-height: 1.35; }
    .popup hr { margin: 6px 0; }

    .topbar {
      position: absolute; z-index: 999;
      top: 10px; left: 10px; right: 10px;
      display: flex; gap: 8px; flex-wrap: wrap;
      align-items: center;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      max-width: 1200px;
    }
    .topbar input {
      flex: 1;
      min-width: 220px;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    .topbar button {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    .status { font-size: 13px; color: #333; }

    .legend {
      position: absolute;
      z-index: 999;
      bottom: 16px;
      left: 16px;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 10px 12px;
      font-family: Arial, sans-serif;
      font-size: 13px;
      line-height: 1.3;
      max-width: 320px;
      user-select: none;
    }
    .legend-title { font-weight: 700; margin-bottom: 8px; }
    .legend-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0;
      cursor: pointer;
    }
    .swatch {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid #00000022;
      flex: 0 0 auto;
    }
    .legend-row.off {
      opacity: 0.35;
    }
    .legend-row .label {
      flex: 1;
    }
    .hint {
      margin-top: 8px;
      font-size: 12px;
      color: #444;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <input id="q" type="text" placeholder="Pretraži po ID / nazivu / struci / mjestu / adresi..." />
    <button id="btnReset" type="button">Reset</button>
    <button id="btnAllOn" type="button">Sve uključi</button>
    <button id="btnAllOff" type="button">Sve isključi</button>
    <span class="status" id="status">Učitavam podatke…</span>
  </div>

  <div class="legend" id="legend">
    <div class="legend-title">Struka</div>
    <div id="legendRows"></div>
    <div class="hint">Klik na struku: uključi/isključi</div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR-5B8-SGXI7FSbUA6gsgpKfECUKq2OnVCj4qM8npiWkrH5gQL00PAfv_NsazCgBNDEv6kwwxOg4Z_x/pub?output=csv";

    const map = L.map("map").setView([45.1, 15.2], 7);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(map);

    const layer = L.layerGroup().addTo(map);
    const statusEl = document.getElementById("status");
    const qEl = document.getElementById("q");
    const btnReset = document.getElementById("btnReset");
    const btnAllOn = document.getElementById("btnAllOn");
    const btnAllOff = document.getElementById("btnAllOff");

    // Definicija struka + boja + ključevi (kako se pojavljuje u tablici nakon toLowerCase().trim())
    const STRUKE = [
      { label: "Instalater(i)", color: "red", keys: ["instalater", "instalateri"] },
      { label: "Arhitekt(i)", color: "blue", keys: ["arhitekt", "arhitekti"] },
      { label: "Prodavač(i)", color: "green", keys: ["prodavač", "prodavac", "prodavači", "prodavaci"] },
      { label: "Građevinar(i)", color: "purple", keys: ["građevinar", "gradevinar", "građevinari", "gradevinari"] },
      { label: "Održavanje zgrada", color: "yellow", keys: ["održavanje zgrada", "odrzavanje zgrada"] },
      { label: "Strojarski projektant", color: "orange", keys: ["strojarski projektant"] }
    ];

    // Mapiranje ključeva na boje (automatski)
    const STRUKA_BOJE = {};
    for (const s of STRUKE) {
      for (const k of s.keys) STRUKA_BOJE[k] = s.color;
    }

    function normalizeStruka(struka) {
      return String(struka || "").toLowerCase().trim();
    }

    function getColorByStruka(struka) {
      const key = normalizeStruka(struka);
      return STRUKA_BOJE[key] || "gray";
    }

    // Aktivne struke (toggle). Default: sve iz STRUKE uključeno
    const activeStrukaKeys = new Set();
    for (const s of STRUKE) {
      for (const k of s.keys) activeStrukaKeys.add(k);
    }

    // Ako želiš da "Ostalo/prazno" bude prikazano, drži true
    let showOther = true;

    let items = [];

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];

        if (ch === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
        if (ch === '"') { inQuotes = !inQuotes; continue; }

        if (ch === "," && !inQuotes) { row.push(cur); cur = ""; continue; }
        if ((ch === "\n" || ch === "\r") && !inQuotes) {
          if (cur.length || row.length) { row.push(cur); rows.push(row); }
          cur = ""; row = [];
          continue;
        }
        cur += ch;
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }
      return rows;
    }

    function toNum(x) {
      const v = parseFloat(String(x || "").trim().replace(",", "."));
      return Number.isFinite(v) ? v : null;
    }

    function normalize(s) {
      return String(s || "").toLowerCase().trim();
    }

    function escHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function findColIndex(header, name) {
      const h = header.map(x => normalize(x));
      return h.indexOf(normalize(name));
    }

    function normalizeWeb(url) {
      const u = String(url || "").trim();
      if (!u) return "";
      if (u.startsWith("http://") || u.startsWith("https://")) return u;
      return "https://" + u;
    }

    function isStrukaActive(struka) {
      const key = normalizeStruka(struka);
      const known = key in STRUKA_BOJE;
      if (!key) return showOther;
      if (!known) return showOther;
      return activeStrukaKeys.has(key);
    }

    function buildLegend() {
      const container = document.getElementById("legendRows");
      container.innerHTML = "";

      for (const s of STRUKE) {
        // Legend row predstavlja cijeli set ključeva (npr. prodavač/prodavac/prodavači/prodavaci)
        const anyOn = s.keys.some(k => activeStrukaKeys.has(k));

        const row = document.createElement("div");
        row.className = "legend-row" + (anyOn ? "" : " off");
        row.dataset.primaryKey = s.keys[0];
        row.innerHTML = `
          <span class="swatch" style="background:${s.color};"></span>
          <span class="label">${s.label}</span>
        `;

        row.addEventListener("click", () => {
          const nowOn = s.keys.some(k => activeStrukaKeys.has(k));
          if (nowOn) {
            for (const k of s.keys) activeStrukaKeys.delete(k);
          } else {
            for (const k of s.keys) activeStrukaKeys.add(k);
          }
          buildLegend();
          renderMarkers(qEl.value);
        });

        container.appendChild(row);
      }

      // Ostalo/prazno toggle
      const otherRow = document.createElement("div");
      otherRow.className = "legend-row" + (showOther ? "" : " off");
      otherRow.innerHTML = `
        <span class="swatch" style="background:gray;"></span>
        <span class="label">Ostalo / prazno</span>
      `;
      otherRow.addEventListener("click", () => {
        showOther = !showOther;
        buildLegend();
        renderMarkers(qEl.value);
      });
      container.appendChild(otherRow);
    }

    function renderMarkers(filterText) {
      layer.clearLayers();

      const ft = normalize(filterText);
      const filteredBase = ft ? items.filter(it => normalize(it.search).includes(ft)) : items.slice();

      // Prvo filtriraj po strukama (toggle)
      const filtered = filteredBase.filter(it => isStrukaActive(it.struka));

      for (const it of filtered) {
        const webLink = it.web ? normalizeWeb(it.web) : "";
        const color = getColorByStruka(it.struka);

        const html = `
          <div class="popup">
            <b>${escHtml(it.naziv)}</b><br>
            ${escHtml(it.adresa)}<br>
            ${escHtml(it.pbr)} ${escHtml(it.mjesto)}<br>
            <hr>
            ${it.id ? `<b>ID:</b> ${escHtml(it.id)}<br>` : ""}
            ${it.struka ? `<b>Struka:</b> ${escHtml(it.struka)}<br>` : ""}
            ${it.osoba ? `<b>Odgovorna osoba:</b> ${escHtml(it.osoba)}<br>` : ""}
            ${it.tel ? `<b>Telefon:</b> ${escHtml(it.tel)}<br>` : ""}
            ${it.email ? `<b>E-mail:</b> ${escHtml(it.email)}<br>` : ""}
            ${it.web ? `<b>Web:</b> <a href="${escHtml(webLink)}" target="_blank" rel="noopener">${escHtml(it.web)}</a><br>` : ""}
          </div>
        `;

        L.circleMarker([it.lat, it.lon], {
          radius: 7,
          color: color,
          weight: 2,
          fillColor: color,
          fillOpacity: 0.85
        })
          .bindTooltip((it.id ? (it.id + " - ") : "") + (it.naziv || "Partner"))
          .bindPopup(html, { maxWidth: 440 })
          .addTo(layer);
      }

      statusEl.textContent = `Prikazano: ${filtered.length} / ${items.length}`;

      if (filtered.length > 0) {
        const bounds = L.latLngBounds(filtered.map(it => [it.lat, it.lon]));
        map.fitBounds(bounds.pad(0.12));
      }
    }

    async function loadData() {
      statusEl.textContent = "Učitavam podatke…";

      const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Ne mogu učitati CSV (HTTP " + res.status + ")");

      const csvText = await res.text();
      const table = parseCSV(csvText);
      if (table.length < 2) throw new Error("CSV nema podataka.");

      const header = table[0];

      const iID     = findColIndex(header, "ID");
      const iStruka = findColIndex(header, "Struka");
      const iNaziv  = findColIndex(header, "Naziv");
      const iAdresa = findColIndex(header, "Adresa");
      const iMjesto = findColIndex(header, "Mjesto");
      const iPbr    = findColIndex(header, "Poštanski broj");
      const iOsoba  = findColIndex(header, "Odgovorna osoba");
      const iTel    = findColIndex(header, "Telefon");
      const iEmail  = findColIndex(header, "E-mail");
      const iWeb    = findColIndex(header, "Web");
      const iLat    = findColIndex(header, "Latitude");
      const iLon    = findColIndex(header, "Longitude");

      if (iNaziv === -1 || iAdresa === -1 || iMjesto === -1 || iPbr === -1 || iLat === -1 || iLon === -1) {
        throw new Error("Nedostaje obavezan stupac: Naziv, Adresa, Mjesto, Poštanski broj, Latitude, Longitude.");
      }

      const out = [];
      for (let r = 1; r < table.length; r++) {
        const row = table[r];

        const lat = toNum(row[iLat]);
        const lon = toNum(row[iLon]);
        if (lat === null || lon === null) continue;

        const id     = iID     !== -1 ? (row[iID] ?? "") : "";
        const struka = iStruka !== -1 ? (row[iStruka] ?? "") : "";

        const naziv  = row[iNaziv]  ?? "";
        const adresa = row[iAdresa] ?? "";
        const mjesto = row[iMjesto] ?? "";
        const pbr    = row[iPbr]    ?? "";

        const osoba  = iOsoba !== -1 ? (row[iOsoba] ?? "") : "";
        const tel    = iTel   !== -1 ? (row[iTel]   ?? "") : "";
        const email  = iEmail !== -1 ? (row[iEmail] ?? "") : "";
        const web    = iWeb   !== -1 ? (row[iWeb]   ?? "") : "";

        out.push({
          lat, lon,
          id, struka, naziv, adresa, mjesto, pbr,
          osoba, tel, email, web,
          search: `${id} ${struka} ${naziv} ${adresa} ${mjesto} ${pbr} ${osoba} ${tel} ${email} ${web}`
        });
      }

      items = out;

      if (items.length === 0) {
        statusEl.textContent = "Nema valjanih koordinata u tablici (Latitude/Longitude).";
        return;
      }

      buildLegend();
      renderMarkers(qEl.value);
    }

    qEl.addEventListener("input", () => renderMarkers(qEl.value));
    btnReset.addEventListener("click", () => { qEl.value = ""; renderMarkers(""); });

    btnAllOn.addEventListener("click", () => {
      activeStrukaKeys.clear();
      for (const s of STRUKE) for (const k of s.keys) activeStrukaKeys.add(k);
      showOther = true;
      buildLegend();
      renderMarkers(qEl.value);
    });

    btnAllOff.addEventListener("click", () => {
      activeStrukaKeys.clear();
      showOther = false;
      buildLegend();
      renderMarkers(qEl.value);
    });

    // Auto-refresh: svake 1 minute
    setInterval(() => {
      loadData().catch(err => {
        console.error(err);
        statusEl.textContent = "Greška pri osvježavanju podataka (vidi konzolu).";
      });
    }, 60000);

    loadData().catch(err => {
      console.error(err);
      statusEl.textContent = "Greška: " + err.message;
      alert("Greška: " + err.message);
    });
  </script>
</body>
</html>

